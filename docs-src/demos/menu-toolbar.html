<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TipTap Editor with PM7 Toolbar - PM7 UI</title>

  <!-- PM7 Core CSS -->
  <link rel="stylesheet" href="/packages/core/src/styles/index.css">

  <!-- TipTap Editor Dependencies -->
  <script type="module">
    import { Editor } from 'https://esm.sh/@tiptap/core@2.1.13'
    import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.1.13'
    import { Color } from 'https://esm.sh/@tiptap/extension-color@2.1.13'
    import TextStyle from 'https://esm.sh/@tiptap/extension-text-style@2.1.13'
    import Underline from 'https://esm.sh/@tiptap/extension-underline@2.1.13'
    import Link from 'https://esm.sh/@tiptap/extension-link@2.1.13'
    import Image from 'https://esm.sh/@tiptap/extension-image@2.1.13'
    import Youtube from 'https://esm.sh/@tiptap/extension-youtube@2.1.13'

    window.Editor = Editor;
    window.StarterKit = StarterKit;
    window.Color = Color;
    window.TextStyle = TextStyle;
    window.Underline = Underline;
    window.Link = Link;
    window.Image = Image;
    window.Youtube = Youtube;
  </script>

  <style>
    body {
      margin: 0;
      font-family: var(--pm7-font-sans);
      background: linear-gradient(135deg, #fafbfc 0%, #f0f2f5 100%);
      color: var(--pm7-foreground);
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: radial-gradient(circle, #e0e0e0 1px, transparent 1px);
      background-size: 20px 20px;
      mask-image: radial-gradient(ellipse at center, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 30%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 80%);
      -webkit-mask-image: radial-gradient(ellipse at center, rgba(0,0,0,1) 0%, rgba(0,0,0,0.8) 30%, rgba(0,0,0,0.3) 60%, rgba(0,0,0,0) 80%);
      pointer-events: none;
    }

    html {
      overflow: hidden;
    }
    
    /* CRITICAL Z-INDEX FIX: Ensure dialogs appear above menus */
    .pm7-dialog-overlay {
      z-index: 10000 !important;
    }
    
    .pm7-dialog-content {
      z-index: 10001 !important;
    }
    
    /* Ensure menu content has lower z-index */
    .pm7-menu-content {
      z-index: 50 !important;
    }

    .app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-toolbar {
      background: var(--pm7-surface);
      border-bottom: 1px solid var(--pm7-border);
      padding: 0;
      display: flex;
      justify-content: center;
      flex-shrink: 0;
    }

    .app-content {
      flex: 1;
      padding: 1rem 2rem 0 2rem;
      padding-bottom: calc(20px + 2.5rem); /* 20px spacing + footer height */
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0; /* Important for Firefox */
    }

    /* Editor container */
    #editor {
      height: 100%;
      overflow: hidden;
    }

    /* TipTap Editor Styles */
    .tiptap {
      background: white;
      border: none;
      border-radius: 0;
      padding: 1.5rem;
      height: 100%;
      font-family: var(--pm7-font-sans);
      font-size: 16px;
      line-height: 1.6;
      outline: none;
      overflow-y: scroll;
      box-sizing: border-box;
    }

    .editor-wrapper:has(.tiptap:focus) {
      border-color: var(--pm7-primary);
    }

    .tiptap h1, .tiptap h2, .tiptap h3 {
      font-weight: 600;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .tiptap h1 { font-size: 2rem; }
    .tiptap h2 { font-size: 1.5rem; }
    .tiptap h3 { font-size: 1.25rem; }

    .tiptap p {
      margin-bottom: 1rem;
    }

    .tiptap ul, .tiptap ol {
      margin-bottom: 1rem;
      padding-left: 2rem;
    }

    .tiptap code {
      background: var(--pm7-muted);
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-family: var(--pm7-font-mono);
      font-size: 0.875em;
    }

    .tiptap pre {
      background: var(--pm7-muted);
      padding: 1rem;
      border-radius: var(--pm7-radius);
      overflow-x: auto;
      margin-bottom: 1rem;
    }

    .tiptap pre code {
      background: none;
      padding: 0;
    }

    .tiptap blockquote {
      border-left: 3px solid var(--pm7-border);
      padding-left: 1rem;
      margin-left: 0;
      font-style: italic;
      color: var(--pm7-muted-foreground);
    }

    .tiptap a {
      color: var(--pm7-primary);
      text-decoration: underline;
    }

    .tiptap a:hover {
      text-decoration: none;
    }

    /* Image styles */
    .tiptap img {
      max-width: 100%;
      height: auto;
      border-radius: var(--pm7-radius);
      margin: 1rem 0;
      display: block;
      cursor: pointer;
    }

    .tiptap img.ProseMirror-selectednode {
      outline: 2px solid var(--pm7-primary);
    }

    /* Image resize wrapper */
    .image-resize-wrapper {
      position: relative;
      display: inline-block;
      margin: 1rem 0;
      max-width: 100%;
    }

    .image-resize-wrapper.ProseMirror-selectednode {
      outline: 2px solid var(--pm7-primary);
    }

    .image-resize-wrapper img {
      display: block;
      max-width: 100%;
      height: auto;
      margin: 0;
    }

    /* Resize handles */
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--pm7-primary);
      border: 2px solid white;
      border-radius: 50%;
      cursor: nwse-resize;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .image-resize-wrapper.ProseMirror-selectednode .resize-handle {
      opacity: 1;
    }

    .resize-handle.nw {
      top: -6px;
      left: -6px;
      cursor: nw-resize;
    }

    .resize-handle.ne {
      top: -6px;
      right: -6px;
      cursor: ne-resize;
    }

    .resize-handle.sw {
      bottom: -6px;
      left: -6px;
      cursor: sw-resize;
    }

    .resize-handle.se {
      bottom: -6px;
      right: -6px;
      cursor: se-resize;
    }

    /* YouTube video styles */
    .tiptap iframe[src*="youtube.com"],
    .tiptap iframe[src*="youtu.be"] {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: var(--pm7-radius);
      margin: 1rem 0;
      display: block;
    }

    .tiptap div[data-youtube-video] {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      margin: 1rem 0;
    }

    .tiptap div[data-youtube-video] iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      border-radius: var(--pm7-radius);
    }

    /* Formatting toolbar */
    .format-toolbar {
      display: flex;
      gap: 0.15rem;
      padding: 0.10rem;
      flex-wrap: wrap;
      margin-bottom: 0.4rem;
      justify-content: center;
      flex-shrink: 0;
    }

    /* Page title */
    .app-content h2 {
      flex-shrink: 0;
      margin-top: 0;
      margin-bottom: 0.35rem;
    }

    .format-group {
      display: flex;
      gap: 0.25rem;
      padding: 0 0.5rem;
      border-right: 1px solid var(--pm7-border);
    }

    .format-group:last-child {
      border-right: none;
    }

    .format-button {
      padding: 0.25rem 0.5rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--pm7-radius);
      cursor: pointer;
      font-size: 14px;
      color: var(--pm7-foreground);
      transition: all 0.2s;
    }

    .format-button:hover {
      background: var(--pm7-muted);
    }

    .format-button.is-active {
      background: var(--pm7-primary);
      color: var(--pm7-primary-foreground);
    }

    .status-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--pm7-muted);
      border-top: 1px solid var(--pm7-border);
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
      color: var(--pm7-muted-foreground);
      display: flex;
      align-items: center;
      z-index: 10;
    }

    .status-left {
      flex: 1;
      text-align: left;
    }

    .status-center {
      flex: 1;
      text-align: center;
    }

    .status-right {
      flex: 1;
      text-align: right;
    }

    .text-stats {
      font-weight: 500;
      background: white;
      border: 1px solid #E0E0E0;
      border-radius: 45px;
      padding: 0.25rem 0.75rem;
      display: inline-block;
    }

    .tooltip-stats-detail {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.875rem;
    }

    .tooltip-stats-detail div {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      white-space: nowrap;
    }

    /* Resizable editor container */
    .editor-container {
      position: relative;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      flex: 1;
      min-height: 0;
    }

    .editor-wrapper {
      position: relative;
      background: white;
      border: 1px solid var(--pm7-border);
      border-radius: var(--pm7-radius);
      width: 800px; /* Default starting width */
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Resize handle */
    .resize-handle {
      position: absolute;
      top: 0;
      width: 12px;
      cursor: ew-resize;
      background: transparent;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s ease;
      user-select: none;
    }

    .resize-handle.visible {
      opacity: 1;
    }

    .resize-handle.resizing {
      /* No visual change during resize */
    }

    /* Visual indicator */
    .resize-handle::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 2px;
      transform: translateY(-50%);
      width: 4px;
      height: 40px;
      background: #E0E0E0;
      border-radius: 2px;
      transition: background 0.2s ease;
    }

    .resize-handle:hover::before {
      background: #999999;
    }

    /* Keep handle appearance consistent during resize */

    /* Prevent menu item text wrapping */
    .pm7-menu-item {
      white-space: nowrap;
    }

    /* Make menu bar triggers same height as menu items */
    .pm7-menu-bar .pm7-menu-trigger {
      padding: var(--pm7-menu-padding-y) var(--pm7-menu-padding-x) !important;
    }

    /* Custom menu padding - 6px vertical instead of 8px */
    .pm7-menu-bar .pm7-menu-trigger,
    .pm7-menu-item {
      padding-top: 6px !important;
      padding-bottom: 6px !important;
    }

    /* Dialog backdrop styles */
    .pm7-dialog-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      z-index: var(--pm7-z-modal, 100);
    }

    .pm7-dialog-backdrop[data-state="open"] {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Ensure dialog close button matches PM7 style */
    #about-dialog .pm7-dialog-close {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }

    /* Adjust TipTap styles for wrapper */
    .editor-wrapper .tiptap {
      border: none;
      border-radius: 0;
    }
    
    /* Custom checkbox styling */
    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--pm7-primary);
    }
    
    


    /* Connected columns card styles */
    .connected-columns-card {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 300px;
      background: var(--pm7-surface);
      border: 1px solid var(--pm7-border);
      border-radius: var(--pm7-radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      z-index: 100;
    }
    
    .connected-columns-card .pm7-card-header {
      padding: 1rem;
      border-bottom: 1px solid var(--pm7-border);
    }
    
    .connected-columns-card .pm7-card-content {
      padding: 1rem;
    }
    
    .connected-columns-card h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }
    
    .column-list {
      margin-top: 1rem;
    }
    
    .column-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0;
    }
    
    .column-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--pm7-primary);
    }
    
    .column-item label {
      flex: 1;
      cursor: pointer;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Application Toolbar -->
    <div class="app-toolbar">
      <div class="pm7-menu-bar pm7-menu-bar--borderless pm7-menu-bar--flat-hover">
        <!-- File Menu -->
        <div class="pm7-menu" data-pm7-menu>
          <button class="pm7-menu-trigger pm7-button pm7-button--ghost pm7-button--sm">
            File
          </button>
          <div class="pm7-menu-content">
            <button class="pm7-menu-item" onclick="newFile()">
              New
              <span class="pm7-menu-shortcut">⌘N</span>
            </button>
            <button class="pm7-menu-item" onclick="openFile()">
              Open...
              <span class="pm7-menu-shortcut">⌘O</span>
            </button>
            <button class="pm7-menu-item" onclick="showRecentFiles()">Recent Files</button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" onclick="saveFile()">
              Save
              <span class="pm7-menu-shortcut">⌘S</span>
            </button>
            <button class="pm7-menu-item" onclick="saveAsFile()">Save As...</button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" onclick="exitApp()">Exit</button>
          </div>
        </div>

        <!-- Edit Menu -->
        <div class="pm7-menu" data-pm7-menu>
          <button class="pm7-menu-trigger pm7-button pm7-button--ghost pm7-button--sm">
            Edit
          </button>
          <div class="pm7-menu-content">
            <button class="pm7-menu-item" id="undo-btn">
              Undo
              <span class="pm7-menu-shortcut">⌘Z</span>
            </button>
            <button class="pm7-menu-item" id="redo-btn">
              Redo
              <span class="pm7-menu-shortcut">⌘⇧Z</span>
            </button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" id="cut-btn">
              Cut
              <span class="pm7-menu-shortcut">⌘X</span>
            </button>
            <button class="pm7-menu-item" id="copy-btn">
              Copy
              <span class="pm7-menu-shortcut">⌘C</span>
            </button>
            <button class="pm7-menu-item" id="paste-btn">
              Paste
              <span class="pm7-menu-shortcut">⌘V</span>
            </button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" id="select-all-btn">
              Select All
              <span class="pm7-menu-shortcut">⌘A</span>
            </button>
          </div>
        </div>

        <!-- Format Menu -->
        <div class="pm7-menu" data-pm7-menu>
          <button class="pm7-menu-trigger pm7-button pm7-button--ghost pm7-button--sm">
            Format
          </button>
          <div class="pm7-menu-content">
            <button class="pm7-menu-item" id="bold-menu">
              Bold
              <span class="pm7-menu-shortcut">⌘B</span>
            </button>
            <button class="pm7-menu-item" id="italic-menu">
              Italic
              <span class="pm7-menu-shortcut">⌘I</span>
            </button>
            <button class="pm7-menu-item" id="underline-menu">
              Underline
              <span class="pm7-menu-shortcut">⌘U</span>
            </button>
            <button class="pm7-menu-item" id="strike-menu">
              Strikethrough
            </button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" id="h1-menu">Heading 1</button>
            <button class="pm7-menu-item" id="h2-menu">Heading 2</button>
            <button class="pm7-menu-item" id="h3-menu">Heading 3</button>
            <button class="pm7-menu-item" id="paragraph-menu">Paragraph</button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" id="bullet-list-menu">Bullet List</button>
            <button class="pm7-menu-item" id="ordered-list-menu">Numbered List</button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" id="code-menu">Code</button>
            <button class="pm7-menu-item" id="code-block-menu">Code Block</button>
            <button class="pm7-menu-item" id="blockquote-menu">Blockquote</button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" id="image-menu">Insert Image...</button>
            <button class="pm7-menu-item" id="video-menu">Insert YouTube Video...</button>
          </div>
        </div>

        <!-- View Menu -->
        <div class="pm7-menu" data-pm7-menu>
          <button class="pm7-menu-trigger pm7-button pm7-button--ghost pm7-button--sm">
            View
          </button>
          <div class="pm7-menu-content">
            <button class="pm7-menu-item pm7-menu-item--checkbox" id="show-document-name" data-checked="true">
              Show document name
            </button>
            <button class="pm7-menu-item pm7-menu-item--checkbox" id="show-toolbar" data-checked="true">
              Show Formatting Toolbar
            </button>
            <div class="pm7-menu-separator"></div>
            <div class="pm7-menu-label">Theme</div>
            <button class="pm7-menu-item pm7-menu-item--radio" data-name="theme" data-value="light" data-checked="true">
              Light
            </button>
            <button class="pm7-menu-item pm7-menu-item--radio" data-name="theme" data-value="dark">
              Dark
            </button>
          </div>
        </div>

        <!-- Tools Menu -->
        <div class="pm7-menu" data-pm7-menu>
          <button class="pm7-menu-trigger pm7-button pm7-button--ghost pm7-button--sm">
            Tools
          </button>
          <div class="pm7-menu-content">
            <button class="pm7-menu-item">Options...</button>
            <button class="pm7-menu-item">Extensions</button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item">Developer Tools</button>
          </div>
        </div>

        <!-- Help Menu -->
        <div class="pm7-menu" data-pm7-menu>
          <button class="pm7-menu-trigger pm7-button pm7-button--ghost pm7-button--sm">
            Help
          </button>
          <div class="pm7-menu-content">
            <button class="pm7-menu-item">Documentation</button>
            <button class="pm7-menu-item">Keyboard Shortcuts</button>
            <div class="pm7-menu-separator"></div>
            <button class="pm7-menu-item" onclick="showAbout()">About</button>
          </div>
        </div>

        <!-- Spacer to push Sign in to the right -->
        <div style="flex: 1;"></div>

        <!-- Sign in / User Menu -->
        <div class="pm7-menu" data-pm7-menu id="user-menu">
          <div class="pm7-tooltip" data-pm7-tooltip id="user-menu-tooltip-wrapper">
            <button class="pm7-menu-trigger pm7-button pm7-button--ghost pm7-button--sm pm7-tooltip-trigger" id="user-menu-trigger">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span id="user-menu-label">Sign in</span>
            </button>
            <div class="pm7-tooltip-content" data-side="bottom" id="sign-in-tooltip" style="display: none;">
              Sign in to save documents to the cloud
              <div class="pm7-tooltip-arrow"></div>
            </div>
          </div>
          <div class="pm7-menu-content" id="user-menu-content">
            <button class="pm7-menu-item" onclick="(function(){ 
              // Close the menu immediately
              const menu = document.querySelector('#user-menu');
              if (menu && menu.PM7Menu) {
                menu.PM7Menu.close();
              } else {
                // Fallback: manually close the menu
                const menuContent = document.querySelector('#user-menu-content');
                if (menuContent) {
                  menuContent.classList.remove('pm7-menu-content--open');
                  menuContent.removeAttribute('data-state');
                }
                const trigger = document.querySelector('#user-menu-trigger');
                if (trigger) {
                  trigger.setAttribute('aria-expanded', 'false');
                }
              }
              // Then open sign in dialog
              window.signIn();
            })()">Sign in</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <main class="app-content">
      <h2 style="text-align: center;">TipTap Editor with PM7 Toolbar</h2>

      <!-- Formatting Toolbar (outside card) -->
      <div class="format-toolbar" id="format-toolbar">
        <div class="format-group">
          <button class="format-button" id="bold-btn" title="Bold (Cmd+B)">
            <strong>B</strong>
          </button>
          <button class="format-button" id="italic-btn" title="Italic (Cmd+I)">
            <em>I</em>
          </button>
          <button class="format-button" id="underline-btn" title="Underline (Cmd+U)">
            <u>U</u>
          </button>
          <button class="format-button" id="strike-btn" title="Strikethrough">
            <s>S</s>
          </button>
        </div>

        <div class="format-group">
          <button class="format-button" id="h1-btn" title="Heading 1">H1</button>
          <button class="format-button" id="h2-btn" title="Heading 2">H2</button>
          <button class="format-button" id="h3-btn" title="Heading 3">H3</button>
          <button class="format-button" id="p-btn" title="Paragraph">P</button>
        </div>

        <div class="format-group">
          <button class="format-button" id="ul-btn" title="Bullet List">• List</button>
          <button class="format-button" id="ol-btn" title="Numbered List">1. List</button>
        </div>

        <div class="format-group">
          <button class="format-button" id="code-btn" title="Code">&lt;/&gt;</button>
          <button class="format-button" id="codeblock-btn" title="Code Block">[&lt;/&gt;]</button>
          <button class="format-button" id="quote-btn" title="Blockquote">"</button>
        </div>

        <div class="format-group">
          <button class="format-button" id="link-btn" title="Add Link">🔗</button>
          <button class="format-button" id="image-btn" title="Add Image">🖼️</button>
          <button class="format-button" id="video-btn" title="Add YouTube Video">📹</button>
          <button class="format-button" id="hr-btn" title="Horizontal Rule">—</button>
        </div>
      </div>

      <!-- Resizable Editor Container -->
      <div class="editor-container" id="editor-container">
        <div class="editor-wrapper">
          <!-- TipTap Editor -->
          <div id="editor"></div>
        </div>

        <!-- Resize Handle (moved outside wrapper) -->
        <div class="resize-handle" id="resize-handle"></div>
      </div>
    </main>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-left">Ready</div>
      <div class="status-center">
        <div class="pm7-tooltip" data-pm7-tooltip data-delay="500" style="display: inline-block;">
          <span class="text-stats pm7-tooltip-trigger">0 | 0 | 0</span>
          <div class="pm7-tooltip-content" data-side="top">
            <div class="tooltip-stats-detail">
              <div>Letters: <strong>0</strong></div>
              <div>Words: <strong>0</strong></div>
              <div>Sentences: <strong>0</strong></div>
            </div>
            <div class="pm7-tooltip-arrow"></div>
          </div>
        </div>
      </div>
      <div class="status-right">Line 1, Column 1</div>
    </div>
  </div>

  <!-- PM7 Core JavaScript -->
  <script src="/packages/core/src/scripts/index.js" type="module"></script>

  <script type="module">
    // Initialize editor after modules load
    (async () => {
      // Wait for modules to load
      await new Promise(resolve => setTimeout(resolve, 100));
      
      // Wait for PM7 to be available
      let attempts = 0;
      while (!window.PM7?.openDialog && attempts < 50) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (!window.PM7?.openDialog) {
        console.error('PM7 dialog functions not available after 5 seconds');
      } else {
        console.log('PM7 dialog functions loaded successfully');
        // Initialize PM7 components including dialogs
        window.PM7.init();
        console.log('PM7 components initialized');
      }

      // Initialize TipTap Editor
      const editor = new window.Editor({
      element: document.querySelector('#editor'),
      extensions: [
        window.StarterKit,
        window.Underline,
        window.TextStyle,
        window.Color,
        window.Link.configure({
          openOnClick: false,
          HTMLAttributes: {
            class: 'tiptap-link',
          },
        }),
        window.Image.configure({
          inline: true,
          allowBase64: true,
          HTMLAttributes: {
            class: 'resizable-img',
          },
        }),
        window.Youtube.configure({
          inline: false,
          width: 640,
          height: 480,
          nocookie: true,
          autoplay: false,
        }),
      ],
      content: `
        <h1>Welcome to TipTap Editor with PM7 UI!</h1>
        <p>This demo integrates the powerful <strong>TipTap editor</strong> with <em>PM7 UI components</em> for a seamless editing experience.</p>

        <h2>Features</h2>
        <ul>
          <li><strong>Rich text formatting</strong> - Bold, italic, underline, and strikethrough</li>
          <li><strong>Headings</strong> - Support for H1, H2, and H3</li>
          <li><strong>Lists</strong> - Both bullet and numbered lists</li>
          <li><strong>Code formatting</strong> - Inline <code>code</code> and code blocks</li>
          <li><strong>Blockquotes</strong> - For highlighting important text</li>
          <li><strong>Links</strong> - Add hyperlinks to your content</li>
          <li><strong>Images</strong> - Insert images from URLs or paste image data</li>
          <li><strong>YouTube Videos</strong> - Embed YouTube videos directly in your content</li>
        </ul>

        <h2>Media Support</h2>
        <p>You can now add images and YouTube videos to your documents! Use the 🖼️ button to insert images and the 📹 button to embed YouTube videos.</p>

        <h3>Example Image</h3>
        <p>Click the image button and try adding an image URL, for example:</p>
        <p><code>https://picsum.photos/600/400</code></p>
        <p><strong>Resize tip:</strong> After inserting an image, click on it to see resize handles at the corners. Drag any corner to resize the image while maintaining aspect ratio!</p>

        <h3>Example Video</h3>
        <p>Click the video button and paste a YouTube URL, for example:</p>
        <p><code>https://www.youtube.com/watch?v=dQw4w9WgXcQ</code></p>

        <h2>Try it out!</h2>
        <p>Use the menu bar above or the formatting toolbar to style your content. All PM7 UI styles are applied for a consistent look and feel.</p>

        <blockquote>
          <p>"The best way to predict the future is to invent it." - Alan Kay</p>
        </blockquote>

        <pre><code>// Example code block
function greet(name) {
  console.log(\`Hello, \${name}!\`);
}</code></pre>
      `,
      autofocus: true,
      editorProps: {
        attributes: {
          class: 'tiptap',
        },
      },
    });

    // Update status function
    function updateStatus(message) {
      const statusLeft = document.querySelector('.status-left');
      statusLeft.textContent = message;
      setTimeout(() => {
        statusLeft.textContent = 'Ready';
      }, 2000);
    }

    // File menu functions
    let currentFileName = 'Untitled.html';
    let hasUnsavedChanges = false;
    let recentFiles = JSON.parse(localStorage.getItem('pm7-editor-recent-files') || '[]');

    // User state
    let currentUser = JSON.parse(localStorage.getItem('pm7-editor-user') || 'null');

    // Track changes
    editor.on('update', () => {
      hasUnsavedChanges = true;
      updateStatus('Modified');
    });

    // Add file to recent files list
    function addToRecentFiles(fileName) {
      recentFiles = recentFiles.filter(f => f !== fileName);
      recentFiles.unshift(fileName);
      recentFiles = recentFiles.slice(0, 5); // Keep only 5 recent files
      localStorage.setItem('pm7-editor-recent-files', JSON.stringify(recentFiles));
    }

    window.showRecentFiles = function() {
      if (recentFiles.length === 0) {
        alert('No recent files');
        return;
      }

      const fileList = recentFiles.map((file, index) => `${index + 1}. ${file}`).join('\n');
      const choice = prompt(`Recent files:\n${fileList}\n\nEnter number to open:`);

      if (choice && !isNaN(choice)) {
        const index = parseInt(choice) - 1;
        if (index >= 0 && index < recentFiles.length) {
          // Simulate opening the file
          currentFileName = recentFiles[index];
          hasUnsavedChanges = false;
          updateStatus(`Opened ${currentFileName} from recent files`);
        }
      }
    };

    window.newFile = function() {
      if (hasUnsavedChanges) {
        if (!confirm('You have unsaved changes. Create a new file anyway?')) {
          return;
        }
      }
      editor.commands.clearContent();
      currentFileName = 'Untitled.html';
      hasUnsavedChanges = false;
      updateStatus('New file created');
    };

    window.openFile = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.html,.txt,.md';

      input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const content = e.target.result;
            // Convert plain text or markdown to HTML if needed
            if (file.name.endsWith('.txt') || file.name.endsWith('.md')) {
              editor.commands.setContent('<p>' + content.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>');
            } else {
              editor.commands.setContent(content);
            }
            currentFileName = file.name;
            hasUnsavedChanges = false;
            addToRecentFiles(file.name);
            updateStatus(`Opened ${file.name}`);
          };
          reader.readAsText(file);
        }
      };

      input.click();
    };

    window.saveFile = function() {
      const content = editor.getHTML();
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = currentFileName;
      a.click();

      URL.revokeObjectURL(url);
      hasUnsavedChanges = false;
      addToRecentFiles(currentFileName);
      updateStatus(`Saved ${currentFileName}`);
    };

    window.saveAsFile = function() {
      const fileName = prompt('Save as:', currentFileName);
      if (fileName) {
        currentFileName = fileName;
        saveFile();
      }
    };

    window.exitApp = function() {
      if (hasUnsavedChanges) {
        const response = confirm('You have unsaved changes. Do you want to save before exiting?');
        if (response) {
          saveFile();
        }
      }
      if (confirm('Are you sure you want to exit?')) {
        updateStatus('Exiting application...');
        // In a real app, this would close the window/tab
        window.close();
      }
    };

    // Initialize dialog once
    window.aboutDialog = null;
    let aboutBackdrop;
    setTimeout(() => {
      const dialogElement = document.querySelector('#about-dialog [data-pm7-dialog]');
      aboutBackdrop = document.getElementById('about-dialog');
      if (dialogElement) {
        window.aboutDialog = new PM7.Dialog(dialogElement);

        // Override open/close to handle backdrop
        const originalOpen = window.aboutDialog.open.bind(window.aboutDialog);
        const originalClose = window.aboutDialog.close.bind(window.aboutDialog);

        window.aboutDialog.open = function() {
          aboutBackdrop.setAttribute('data-state', 'open');
          originalOpen();
        };

        window.aboutDialog.close = function() {
          aboutBackdrop.removeAttribute('data-state');
          originalClose();
        };
      }
    }, 100);

    window.showAbout = function() {
      if (window.aboutDialog) {
        window.aboutDialog.open();
      }
    };


    // User authentication functions
    function updateUserMenu() {
      const menuLabel = document.getElementById('user-menu-label');
      const menuContent = document.getElementById('user-menu-content');

      if (currentUser) {
        // User is signed in
        menuLabel.textContent = currentUser.name;
        menuContent.innerHTML = `
          <button class="pm7-menu-item" onclick="(function(){ document.querySelectorAll('.pm7-menu-content, .pm7-menu, [data-pm7-menu]').forEach(el => el.style.display = 'none'); setTimeout(() => window.accountSettings(), 10); })()">Account settings</button>
          <div class="pm7-menu-separator"></div>
          <button class="pm7-menu-item" onclick="(function(){ document.querySelectorAll('.pm7-menu-content, .pm7-menu, [data-pm7-menu]').forEach(el => el.style.display = 'none'); setTimeout(() => window.signOut(), 10); })()">Sign out</button>
        `;
        
        // Hide tooltip when signed in
        const tooltipContent = document.getElementById('sign-in-tooltip');
        if (tooltipContent) {
          tooltipContent.style.display = 'none';
        }
        
        // Restore menu functionality
        const menuElement = document.getElementById('user-menu');
        const menuTrigger = document.getElementById('user-menu-trigger');
        if (menuElement) {
          // Remove direct onclick
          if (menuTrigger) {
            menuTrigger.onclick = null;
          }
          // Ensure menu is properly initialized
          if (!menuElement.PM7Menu) {
            new PM7.Menu(menuElement);
          }
        }
      } else {
        // User is not signed in - no submenu needed
        menuLabel.textContent = 'Sign in';
        menuContent.innerHTML = `
          <button class="pm7-menu-item" onclick="(function(){ 
            // Close the menu immediately
            const menu = document.querySelector('#user-menu');
            if (menu && menu.PM7Menu) {
              menu.PM7Menu.close();
            } else {
              // Fallback: manually close the menu
              const menuContent = document.querySelector('#user-menu-content');
              if (menuContent) {
                menuContent.classList.remove('pm7-menu-content--open');
                menuContent.removeAttribute('data-state');
              }
              const trigger = document.querySelector('#user-menu-trigger');
              if (trigger) {
                trigger.setAttribute('aria-expanded', 'false');
              }
            }
            // Then open sign in dialog
            window.signIn();
          })()">Sign in</button>
        `;
        
        // Show tooltip for sign in
        const tooltipContent = document.getElementById('sign-in-tooltip');
        if (tooltipContent) {
          tooltipContent.style.display = '';
        }
        
        // Remove menu trigger functionality and make it a direct button
        const menuElement = document.getElementById('user-menu');
        if (menuElement && menuElement.PM7Menu) {
          // Remove the menu functionality temporarily
          menuElement.PM7Menu.close();
        }
        // Change onclick to directly open login
        const menuTrigger = document.getElementById('user-menu-trigger');
        if (menuTrigger) {
          menuTrigger.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            window.signIn();
            return false;
          };
        }
      }
    }

    window.signIn = function() {
      // Open the login dialog - our patch will close menus
      if (window.PM7?.openDialog) {
        window.PM7.openDialog('login-dialog');
        // Focus on username field after dialog opens
        setTimeout(() => {
          const usernameField = document.getElementById('username');
          if (usernameField) {
            usernameField.focus();
          }
        }, 200);
      } else {
        console.error('PM7.openDialog is not available');
      }
    };

    window.signOut = function() {
      // Open the sign out confirmation dialog - PM7 now automatically closes menus
      if (window.PM7?.openDialog) {
        window.PM7.openDialog('signout-dialog');
      } else {
        console.error('PM7.openDialog not available');
      }
    };

    window.confirmSignOut = function() {
      currentUser = null;
      localStorage.removeItem('pm7-editor-user');
      updateUserMenu();
      updateStatus('Signed out successfully');
      
      // Close the dialog
      if (window.PM7?.closeDialog) {
        window.PM7.closeDialog('signout-dialog');
      }
    };

    window.accountSettings = function() {
      // First, aggressively hide ALL menus
      const hideMenus = () => {
        // Hide all menu-related elements
        const elements = document.querySelectorAll('.pm7-menu-content, .pm7-menu, [data-pm7-menu]');
        elements.forEach(el => {
          el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; z-index: 1 !important;';
        });
        
        // Add global style to ensure menus stay hidden
        let globalStyle = document.getElementById('global-menu-hide');
        if (!globalStyle) {
          globalStyle = document.createElement('style');
          globalStyle.id = 'global-menu-hide';
          document.head.appendChild(globalStyle);
        }
        globalStyle.textContent = `
          .pm7-menu-content,
          .pm7-menu,
          [data-pm7-menu] {
            display: none !important;
          }
        `;
        
        // Remove after delay
        setTimeout(() => {
          if (globalStyle) globalStyle.remove();
        }, 500);
      };
      
      // Hide menus immediately
      hideMenus();
      
      if (!currentUser) {
        console.error('No current user');
        return;
      }
      
      // Populate the account settings form with current user data
      document.getElementById('settings-username').value = currentUser.name;
      document.getElementById('settings-user-email').value = currentUser.email;
      document.getElementById('settings-name').textContent = currentUser.name;
      document.getElementById('settings-email').textContent = currentUser.email;
      
      // Set avatar
      const avatarDiv = document.getElementById('settings-avatar');
      if (currentUser.avatar && avatarDiv) {
        // Use saved photo
        avatarDiv.style.backgroundImage = `url(${currentUser.avatar})`;
        avatarDiv.style.backgroundSize = 'cover';
        avatarDiv.style.backgroundPosition = 'center';
        avatarDiv.style.backgroundColor = 'transparent';
        avatarDiv.innerHTML = ''; // Remove initials
      } else {
        // Use initials
        const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const initialsSpan = document.getElementById('avatar-initials');
        if (initialsSpan) {
          initialsSpan.textContent = initials;
        }
        if (avatarDiv) {
          avatarDiv.style.backgroundImage = '';
          avatarDiv.style.backgroundColor = 'var(--pm7-primary)';
          // Re-add initials span if it was removed
          if (!avatarDiv.querySelector('#avatar-initials')) {
            avatarDiv.innerHTML = `<span style="color: var(--pm7-primary-foreground); font-size: 2rem; font-weight: 600;" id="avatar-initials">${initials}</span>`;
          }
        }
      }
      
      // Open the account settings dialog - our patch will close menus
      if (window.PM7?.openDialog) {
        window.PM7.openDialog('account-settings-dialog');
      } else {
        console.error('PM7.openDialog not available');
      }
    };

    window.handleAccountSettings = function(event) {
      event.preventDefault();
      
      const newName = document.getElementById('settings-username').value;
      const newEmail = document.getElementById('settings-user-email').value;
      const emailNotifications = document.getElementById('email-notifications').checked;
      const autoSave = document.getElementById('auto-save').checked;
      const showTips = document.getElementById('show-tips').checked;
      
      // Update user data
      currentUser.name = newName;
      currentUser.email = newEmail;
      currentUser.preferences = {
        emailNotifications,
        autoSave,
        showTips
      };
      
      // Save to localStorage
      localStorage.setItem('pm7-editor-user', JSON.stringify(currentUser));
      
      // Update UI
      updateUserMenu();
      updateStatus('Settings saved successfully');
      
      // Close the dialog
      if (window.PM7?.closeDialog) {
        window.PM7.closeDialog('account-settings-dialog');
      }
    };

    window.deleteAccount = function() {
      if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        currentUser = null;
        localStorage.removeItem('pm7-editor-user');
        updateUserMenu();
        updateStatus('Account deleted');
        
        // Close the settings dialog
        if (window.PM7?.closeDialog) {
          window.PM7.closeDialog('account-settings-dialog');
        }
      }
    };

    window.changePhoto = function() {
      // Create a file input element
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      
      fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (file) {
          // Check file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('File size must be less than 5MB');
            return;
          }
          
          // Check file type
          if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
          }
          
          // Read the file and convert to base64
          const reader = new FileReader();
          reader.onload = function(e) {
            // Update the avatar with the uploaded image
            const avatarDiv = document.getElementById('settings-avatar');
            if (avatarDiv) {
              avatarDiv.style.backgroundImage = `url(${e.target.result})`;
              avatarDiv.style.backgroundSize = 'cover';
              avatarDiv.style.backgroundPosition = 'center';
              avatarDiv.style.backgroundColor = 'transparent';
              avatarDiv.innerHTML = ''; // Remove initials
              
              // Save to user data
              if (currentUser) {
                currentUser.avatar = e.target.result;
                localStorage.setItem('pm7-editor-user', JSON.stringify(currentUser));
                updateStatus('Photo updated');
              }
            } else {
              console.error('Avatar element not found');
            }
          };
          
          reader.readAsDataURL(file);
        }
      };
      
      // Trigger file selection
      fileInput.click();
    };

    // Handle login form submission
    window.handleLogin = function(event) {
      event.preventDefault();
      
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const remember = document.getElementById('remember').checked;
      
      // Simulate login (in real app, this would validate credentials)
      if (username && password) {
        // Extract name from username/email
        const name = username.includes('@') ? username.split('@')[0] : username;
        const formattedName = name.charAt(0).toUpperCase() + name.slice(1);
        
        currentUser = { 
          name: formattedName, 
          email: username.includes('@') ? username : `${username}@example.com`,
          remember: remember
        };
        
        localStorage.setItem('pm7-editor-user', JSON.stringify(currentUser));
        updateUserMenu();
        updateStatus(`Welcome, ${formattedName}!`);
        
        // Close the dialog
        if (window.PM7?.closeDialog) {
          window.PM7.closeDialog('login-dialog');
        }
        
        // Clear the form
        document.getElementById('login-form').reset();
      }
    };
    

    // Initialize user menu on load
    updateUserMenu();
    
    // Initialize dialog after PM7 is loaded
    setTimeout(() => {
      const loginDialog = document.querySelector('[data-pm7-dialog="login-dialog"]');
      if (loginDialog && window.PM7?.Dialog && !loginDialog.hasAttribute('data-pm7-dialog-initialized')) {
        new window.PM7.Dialog(loginDialog);
        loginDialog.setAttribute('data-pm7-dialog-initialized', 'true');
        console.log('Login dialog initialized');
      }
    }, 200);

    // Toolbar button handlers
    document.getElementById('bold-btn').onclick = () => editor.chain().focus().toggleBold().run();
    document.getElementById('italic-btn').onclick = () => editor.chain().focus().toggleItalic().run();
    document.getElementById('underline-btn').onclick = () => editor.chain().focus().toggleUnderline().run();
    document.getElementById('strike-btn').onclick = () => editor.chain().focus().toggleStrike().run();

    document.getElementById('h1-btn').onclick = () => editor.chain().focus().toggleHeading({ level: 1 }).run();
    document.getElementById('h2-btn').onclick = () => editor.chain().focus().toggleHeading({ level: 2 }).run();
    document.getElementById('h3-btn').onclick = () => editor.chain().focus().toggleHeading({ level: 3 }).run();
    document.getElementById('p-btn').onclick = () => editor.chain().focus().setParagraph().run();

    document.getElementById('ul-btn').onclick = () => editor.chain().focus().toggleBulletList().run();
    document.getElementById('ol-btn').onclick = () => editor.chain().focus().toggleOrderedList().run();

    document.getElementById('code-btn').onclick = () => editor.chain().focus().toggleCode().run();
    document.getElementById('codeblock-btn').onclick = () => editor.chain().focus().toggleCodeBlock().run();
    document.getElementById('quote-btn').onclick = () => editor.chain().focus().toggleBlockquote().run();

    document.getElementById('link-btn').onclick = () => {
      const url = prompt('Enter URL:');
      if (url) {
        editor.chain().focus().setLink({ href: url }).run();
      }
    };

    document.getElementById('image-btn').onclick = () => {
      const url = prompt('Enter image URL or paste image data:');
      if (url) {
        // Ask for size preference
        const size = prompt('Image width in pixels (leave empty for auto):', '600');
        if (size && !isNaN(size)) {
          editor.chain().focus().setImage({ src: url, width: parseInt(size) }).run();
        } else {
          editor.chain().focus().setImage({ src: url }).run();
        }
      }
    };

    document.getElementById('video-btn').onclick = () => {
      const url = prompt('Enter YouTube video URL:');
      if (url) {
        editor.chain().focus().setYoutubeVideo({ src: url }).run();
      }
    };

    document.getElementById('hr-btn').onclick = () => editor.chain().focus().setHorizontalRule().run();

    // Menu bar handlers
    document.getElementById('undo-btn').onclick = () => {
      editor.chain().focus().undo().run();
      updateStatus('Undo');
    };

    document.getElementById('redo-btn').onclick = () => {
      editor.chain().focus().redo().run();
      updateStatus('Redo');
    };

    document.getElementById('cut-btn').onclick = () => {
      document.execCommand('cut');
      updateStatus('Cut');
    };

    document.getElementById('copy-btn').onclick = () => {
      document.execCommand('copy');
      updateStatus('Copied');
    };

    document.getElementById('paste-btn').onclick = () => {
      document.execCommand('paste');
      updateStatus('Pasted');
    };

    document.getElementById('select-all-btn').onclick = () => {
      editor.chain().focus().selectAll().run();
      updateStatus('Selected all');
    };

    // Format menu handlers
    document.getElementById('bold-menu').onclick = () => {
      editor.chain().focus().toggleBold().run();
      updateStatus('Bold toggled');
    };
    document.getElementById('italic-menu').onclick = () => {
      editor.chain().focus().toggleItalic().run();
      updateStatus('Italic toggled');
    };
    document.getElementById('underline-menu').onclick = () => {
      editor.chain().focus().toggleUnderline().run();
      updateStatus('Underline toggled');
    };
    document.getElementById('strike-menu').onclick = () => {
      editor.chain().focus().toggleStrike().run();
      updateStatus('Strikethrough toggled');
    };
    document.getElementById('h1-menu').onclick = () => {
      editor.chain().focus().toggleHeading({ level: 1 }).run();
      updateStatus('Heading 1 applied');
    };
    document.getElementById('h2-menu').onclick = () => {
      editor.chain().focus().toggleHeading({ level: 2 }).run();
      updateStatus('Heading 2 applied');
    };
    document.getElementById('h3-menu').onclick = () => {
      editor.chain().focus().toggleHeading({ level: 3 }).run();
      updateStatus('Heading 3 applied');
    };
    document.getElementById('paragraph-menu').onclick = () => {
      editor.chain().focus().setParagraph().run();
      updateStatus('Paragraph style applied');
    };
    document.getElementById('bullet-list-menu').onclick = () => {
      editor.chain().focus().toggleBulletList().run();
      updateStatus('Bullet list toggled');
    };
    document.getElementById('ordered-list-menu').onclick = () => {
      editor.chain().focus().toggleOrderedList().run();
      updateStatus('Numbered list toggled');
    };
    document.getElementById('code-menu').onclick = () => {
      editor.chain().focus().toggleCode().run();
      updateStatus('Code formatting toggled');
    };
    document.getElementById('code-block-menu').onclick = () => {
      editor.chain().focus().toggleCodeBlock().run();
      updateStatus('Code block toggled');
    };
    document.getElementById('blockquote-menu').onclick = () => {
      editor.chain().focus().toggleBlockquote().run();
      updateStatus('Blockquote toggled');
    };
    document.getElementById('image-menu').onclick = () => {
      const url = prompt('Enter image URL or paste image data:');
      if (url) {
        // Ask for size preference
        const size = prompt('Image width in pixels (leave empty for auto):', '600');
        if (size && !isNaN(size)) {
          editor.chain().focus().setImage({ src: url, width: parseInt(size) }).run();
        } else {
          editor.chain().focus().setImage({ src: url }).run();
        }
        updateStatus('Image inserted');
      }
    };
    document.getElementById('video-menu').onclick = () => {
      const url = prompt('Enter YouTube video URL:');
      if (url) {
        editor.chain().focus().setYoutubeVideo({ src: url }).run();
        updateStatus('Video inserted');
      }
    };

    // Show/hide document name
    document.getElementById('show-document-name').onclick = function() {
      const title = document.querySelector('.app-content h2');
      const isChecked = this.dataset.checked === 'true';
      title.style.display = isChecked ? 'block' : 'none';
      // Reposition handle when title visibility changes
      setTimeout(positionHandle, 50);
    };

    // Show/hide toolbar
    document.getElementById('show-toolbar').onclick = function() {
      const toolbar = document.getElementById('format-toolbar');
      const isChecked = this.dataset.checked === 'true';
      toolbar.style.display = isChecked ? 'flex' : 'none';
      // Reposition handle when toolbar visibility changes
      setTimeout(positionHandle, 50);
    };

    // Update button states based on editor state
    editor.on('selectionUpdate', () => {
      // Toolbar buttons
      document.getElementById('bold-btn').classList.toggle('is-active', editor.isActive('bold'));
      document.getElementById('italic-btn').classList.toggle('is-active', editor.isActive('italic'));
      document.getElementById('underline-btn').classList.toggle('is-active', editor.isActive('underline'));
      document.getElementById('strike-btn').classList.toggle('is-active', editor.isActive('strike'));
      document.getElementById('h1-btn').classList.toggle('is-active', editor.isActive('heading', { level: 1 }));
      document.getElementById('h2-btn').classList.toggle('is-active', editor.isActive('heading', { level: 2 }));
      document.getElementById('h3-btn').classList.toggle('is-active', editor.isActive('heading', { level: 3 }));
      document.getElementById('p-btn').classList.toggle('is-active', editor.isActive('paragraph'));
      document.getElementById('ul-btn').classList.toggle('is-active', editor.isActive('bulletList'));
      document.getElementById('ol-btn').classList.toggle('is-active', editor.isActive('orderedList'));
      document.getElementById('code-btn').classList.toggle('is-active', editor.isActive('code'));
      document.getElementById('codeblock-btn').classList.toggle('is-active', editor.isActive('codeBlock'));
      document.getElementById('quote-btn').classList.toggle('is-active', editor.isActive('blockquote'));
    });

    // Dark mode support
    const darkModeEnabled = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (darkModeEnabled) {
      document.documentElement.classList.add('dark');
    }

    // Handle theme switching
    document.querySelectorAll('[data-name="theme"]').forEach(btn => {
      btn.addEventListener('click', () => {
        const isDark = btn.dataset.value === 'dark';
        document.documentElement.classList.toggle('dark', isDark);
      });
    });

    // Function to count sentences
    function countSentences(text) {
      // Remove extra spaces and newlines
      text = text.replace(/\s+/g, ' ').trim();
      if (text.length === 0) return 0;

      // Split by sentence-ending punctuation followed by space or end of string
      const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
      return sentences.length;
    }

    // Function to update text statistics
    function updateTextStats() {
      const text = editor.state.doc.textContent;

      // Count letters (excluding spaces)
      const letters = text.replace(/\s/g, '').length;

      // Count words
      const words = text.trim() === '' ? 0 : text.trim().split(/\s+/).length;

      // Count sentences
      const sentences = countSentences(text);

      // Update display
      document.querySelector('.text-stats').textContent = `${letters} | ${words} | ${sentences}`;

      // Update tooltip details
      const tooltipDetail = document.querySelector('.tooltip-stats-detail');
      tooltipDetail.innerHTML = `
        <div>Letters: <strong>${letters}</strong></div>
        <div>Words: <strong>${words}</strong></div>
        <div>Sentences: <strong>${sentences}</strong></div>
      `;
    }

    // Update statistics on content change
    editor.on('update', updateTextStats);

    // Initial statistics update
    updateTextStats();

    // Image resize functionality
    let currentResizingImage = null;
    let imgStartWidth = 0;
    let imgStartHeight = 0;
    let imgStartX = 0;
    let imgStartY = 0;
    let imgAspectRatio = 1;

    // Add resize functionality to images
    function makeImageResizable(img) {
      if (img.dataset.resizable === 'true') return;
      
      img.dataset.resizable = 'true';
      img.style.cursor = 'pointer';
      
      // Create a wrapper for the image if it doesn't exist
      let wrapper = img.parentElement;
      if (!wrapper || !wrapper.classList.contains('image-resize-wrapper')) {
        wrapper = document.createElement('div');
        wrapper.className = 'image-resize-wrapper';
        
        // Check if image has width attribute
        const imgWidth = img.getAttribute('width') || img.naturalWidth || img.width;
        wrapper.style.width = imgWidth + 'px';
        
        img.parentNode.insertBefore(wrapper, img);
        wrapper.appendChild(img);
      }

      // Add resize handles
      const handles = ['nw', 'ne', 'sw', 'se'];
      handles.forEach(handle => {
        const resizeHandle = document.createElement('div');
        resizeHandle.className = `resize-handle ${handle}`;
        resizeHandle.addEventListener('mousedown', (e) => startResize(e, img, handle));
        wrapper.appendChild(resizeHandle);
      });
    }

    function startResize(e, img, handle) {
      e.preventDefault();
      e.stopPropagation();
      
      currentResizingImage = img;
      const wrapper = img.parentElement;
      imgStartWidth = wrapper.offsetWidth;
      imgStartHeight = wrapper.offsetHeight;
      imgStartX = e.clientX;
      imgStartY = e.clientY;
      imgAspectRatio = imgStartWidth / imgStartHeight;
      
      document.addEventListener('mousemove', handleResize);
      document.addEventListener('mouseup', stopResize);
      document.body.style.cursor = `${handle}-resize`;
    }

    function handleResize(e) {
      if (!currentResizingImage) return;
      
      const wrapper = currentResizingImage.parentElement;
      const deltaX = e.clientX - imgStartX;
      const deltaY = e.clientY - imgStartY;
      
      // Calculate new dimensions maintaining aspect ratio
      let newWidth = imgStartWidth + deltaX;
      let newHeight = newWidth / imgAspectRatio;
      
      // Set minimum size
      newWidth = Math.max(100, newWidth);
      newHeight = Math.max(100, newHeight);
      
      // Set maximum size (container width)
      const maxWidth = editor.view.dom.offsetWidth - 40;
      if (newWidth > maxWidth) {
        newWidth = maxWidth;
        newHeight = newWidth / imgAspectRatio;
      }
      
      wrapper.style.width = newWidth + 'px';
      currentResizingImage.style.width = '100%';
      currentResizingImage.style.height = 'auto';
      
      // Update the image attributes in the editor
      const transaction = editor.state.tr;
      editor.view.state.doc.descendants((node, pos) => {
        if (node.type.name === 'image' && node.attrs.src === currentResizingImage.src) {
          transaction.setNodeMarkup(pos, null, {
            ...node.attrs,
            width: Math.round(newWidth),
          });
        }
      });
      editor.view.dispatch(transaction);
    }

    function stopResize() {
      currentResizingImage = null;
      document.removeEventListener('mousemove', handleResize);
      document.removeEventListener('mouseup', stopResize);
      document.body.style.cursor = '';
    }

    // Observer to watch for new images
    const imageObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeName === 'IMG' && node.classList.contains('resizable-img')) {
            // Wait for image to load
            if (node.complete) {
              makeImageResizable(node);
            } else {
              node.addEventListener('load', () => makeImageResizable(node));
            }
          }
        });
      });
    });

    // Start observing the editor for new images
    imageObserver.observe(editor.view.dom, {
      childList: true,
      subtree: true,
    });

    // Make existing images resizable
    editor.view.dom.querySelectorAll('img.resizable-img').forEach(img => {
      if (img.complete) {
        makeImageResizable(img);
      } else {
        img.addEventListener('load', () => makeImageResizable(img));
      }
    });

    // Update cursor position
    editor.on('selectionUpdate', () => {
      // This is a simplified version - real implementation would calculate actual line/column
      const { from } = editor.state.selection;
      const text = editor.state.doc.textContent;
      const lines = text.substring(0, from).split('\n');
      const line = lines.length;
      const col = lines[lines.length - 1].length + 1;
      document.querySelector('.status-right').textContent = `Line ${line}, Column ${col}`;
    });

    // Resize functionality
    const resizeHandle = document.getElementById('resize-handle');
    const editorContainer = document.getElementById('editor-container');
    const editorWrapper = editorContainer.querySelector('.editor-wrapper');
    let isResizing = false;
    let startX;
    let startWidth;

    // Load saved width from localStorage
    const savedWidth = localStorage.getItem('pm7-editor-width');
    if (savedWidth) {
      editorWrapper.style.width = savedWidth + 'px';
    }

    // Position handle next to wrapper
    function positionHandle() {
      const wrapperRect = editorWrapper.getBoundingClientRect();
      const containerRect = editorContainer.getBoundingClientRect();
      const rightEdge = wrapperRect.right - containerRect.left + 8;
      resizeHandle.style.left = rightEdge + 'px';
      resizeHandle.style.height = wrapperRect.height + 'px';

      // Show the handle after positioning
      resizeHandle.classList.add('visible');
    }

    // Initial positioning after a short delay to ensure DOM is ready
    setTimeout(positionHandle, 100);
    window.addEventListener('resize', positionHandle);

    // Also reposition when editor content changes
    editor.on('update', () => {
      setTimeout(positionHandle, 50);
    });

    // Double-click to reset to default width
    resizeHandle.addEventListener('dblclick', (e) => {
      const defaultWidth = 800;
      const maxWidth = window.innerWidth * 0.9;
      const newWidth = Math.min(defaultWidth, maxWidth);

      editorWrapper.style.width = newWidth + 'px';
      localStorage.setItem('pm7-editor-width', newWidth);
      positionHandle();
      e.preventDefault();
    });

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      startX = e.pageX;
      startWidth = editorWrapper.offsetWidth;
      resizeHandle.classList.add('resizing');
      document.body.style.cursor = 'ew-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;

      const containerRect = editorContainer.getBoundingClientRect();
      const wrapperRect = editorWrapper.getBoundingClientRect();

      // Calculate new width based on mouse position
      const newWidth = (e.pageX - containerRect.left) - (wrapperRect.left - containerRect.left) - 8;

      // Set minimum width only (no maximum)
      const minWidth = 400;

      if (newWidth >= minWidth) {
        editorWrapper.style.width = newWidth + 'px';
        // Update handle position directly during drag
        resizeHandle.style.left = (e.pageX - containerRect.left) + 'px';
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        resizeHandle.classList.remove('resizing');
        document.body.style.cursor = '';
        // Save the new width to localStorage
        localStorage.setItem('pm7-editor-width', editorWrapper.offsetWidth);
        // Reposition handle properly after resize
        positionHandle();
      }
    });

    // Touch support for mobile
    resizeHandle.addEventListener('touchstart', (e) => {
      isResizing = true;
      startX = e.touches[0].pageX;
      startWidth = editorWrapper.offsetWidth;
      resizeHandle.classList.add('resizing');
      e.preventDefault();
    });

    document.addEventListener('touchmove', (e) => {
      if (!isResizing) return;

      const containerRect = editorContainer.getBoundingClientRect();
      const wrapperRect = editorWrapper.getBoundingClientRect();

      // Calculate new width based on touch position
      const newWidth = (e.touches[0].pageX - containerRect.left) - (wrapperRect.left - containerRect.left) - 8;

      // Set minimum width only (no maximum)
      const minWidth = 400;

      if (newWidth >= minWidth) {
        editorWrapper.style.width = newWidth + 'px';
        // Update handle position directly during drag
        resizeHandle.style.left = (e.touches[0].pageX - containerRect.left) + 'px';
      }
    });

    document.addEventListener('touchend', () => {
      if (isResizing) {
        isResizing = false;
        resizeHandle.classList.remove('resizing');
        // Save the new width to localStorage
        localStorage.setItem('pm7-editor-width', editorWrapper.offsetWidth);
        // Reposition handle properly after resize
        positionHandle();
      }
    });
    })(); // End of async initialization
  </script>

  <!-- About Dialog -->
  <div class="pm7-dialog-backdrop" id="about-dialog">
    <div class="pm7-dialog" data-pm7-dialog>
    <div class="pm7-dialog-content">
      <div class="pm7-dialog-header">
        <h2 class="pm7-dialog-title">About TipTap Editor with PM7 UI</h2>
        <button class="pm7-dialog-close" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="pm7-dialog-body">
        <div style="text-align: center; margin-bottom: 2rem;">
          <div style="width: 80px; height: 80px; background: var(--pm7-primary); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="white">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
          </div>
          <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem;">Version 2.0.0</h3>
          <p style="color: var(--pm7-muted-foreground);">A powerful rich text editor integration</p>
        </div>

        <div class="pm7-card" style="background: var(--pm7-muted); padding: 1.5rem; margin-bottom: 1.5rem;">
          <h4 style="margin-bottom: 1rem;">What's Included</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div style="width: 8px; height: 8px; background: var(--pm7-primary); border-radius: 50%;"></div>
                <strong>TipTap Editor</strong>
              </div>
              <p style="font-size: 0.875rem; color: var(--pm7-muted-foreground); margin-left: 1rem;">
                Advanced rich text editing with full keyboard support
              </p>
            </div>
            <div>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div style="width: 8px; height: 8px; background: var(--pm7-primary); border-radius: 50%;"></div>
                <strong>PM7 UI Components</strong>
              </div>
              <p style="font-size: 0.875rem; color: var(--pm7-muted-foreground); margin-left: 1rem;">
                Beautiful, accessible UI components
              </p>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <h4 style="margin-bottom: 1rem;">Key Features</h4>
          <ul style="list-style: none; padding: 0;">
            <li style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--pm7-primary)" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <span>Resizable editor with smooth drag handle</span>
            </li>
            <li style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--pm7-primary)" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <span>Traditional desktop-style menu bar</span>
            </li>
            <li style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--pm7-primary)" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <span>Rich text formatting toolbar</span>
            </li>
            <li style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--pm7-primary)" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <span>Dark mode support</span>
            </li>
          </ul>
        </div>

        <div style="padding: 1rem; background: var(--pm7-card); border: 1px solid var(--pm7-border); border-radius: var(--pm7-radius); text-align: center;">
          <p style="margin-bottom: 0.5rem; color: var(--pm7-muted-foreground); font-size: 0.875rem;">Built with</p>
          <div style="display: flex; gap: 1rem; justify-content: center; align-items: center;">
            <a href="https://tiptap.dev" target="_blank" style="color: var(--pm7-primary); text-decoration: none; font-weight: 500;">TipTap</a>
            <span style="color: var(--pm7-muted-foreground);">•</span>
            <a href="https://pm7-ui.com" target="_blank" style="color: var(--pm7-primary); text-decoration: none; font-weight: 500;">PM7 UI</a>
          </div>
        </div>
      </div>
      <div class="pm7-dialog-footer">
        <button class="pm7-button pm7-button--primary" onclick="if(window.aboutDialog) aboutDialog.close()">
          Got it!
        </button>
      </div>
    </div>
  </div>
  </div>
  
  <!-- Login Dialog -->
  <div data-pm7-dialog="login-dialog" data-pm7-dialog-size="sm" data-pm7-show-close="true">
    <h2 data-pm7-header>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
      Sign In
    </h2>
    <div data-pm7-body>
      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="pm7-form-group" style="margin-bottom: 1rem;">
          <label for="username" class="pm7-label">Username or Email</label>
          <input type="text" id="username" name="username" class="pm7-input" placeholder="Enter your username" required>
        </div>
        <div class="pm7-form-group" style="margin-bottom: 1.5rem;">
          <label for="password" class="pm7-label">Password</label>
          <input type="password" id="password" name="password" class="pm7-input" placeholder="Enter your password" required>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
          <label class="pm7-checkbox">
            <input type="checkbox" id="remember" name="remember">
            <span class="pm7-checkbox-indicator"></span>
            <span class="pm7-checkbox-label">Remember me</span>
          </label>
          <a href="#" style="font-size: 0.875rem; color: var(--pm7-primary); text-decoration: none;">Forgot password?</a>
        </div>
      </form>
    </div>
    <div data-pm7-footer style="display: flex; gap: 0.5rem; justify-content: flex-end;">
      <button type="button" class="pm7-button pm7-button--ghost" onclick="window.PM7?.closeDialog?.('login-dialog')">Cancel</button>
      <button type="submit" form="login-form" class="pm7-button pm7-button--primary">Sign In</button>
    </div>
  </div>

  <!-- Account Settings Dialog -->
  <div data-pm7-dialog="account-settings-dialog" data-pm7-dialog-size="md" data-pm7-show-close="true">
    <h2 data-pm7-header>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
      Account Settings
    </h2>
    <div data-pm7-body>
      <form id="account-settings-form" onsubmit="handleAccountSettings(event)">
        <div style="display: flex; align-items: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--pm7-border);">
          <div id="settings-avatar" style="width: 80px; height: 80px; border-radius: 50%; background: var(--pm7-primary); display: flex; align-items: center; justify-content: center; margin-right: 1.5rem; flex-shrink: 0;">
            <span style="color: var(--pm7-primary-foreground); font-size: 2rem; font-weight: 600;" id="avatar-initials">JD</span>
          </div>
          <div style="flex: 1;">
            <h3 style="margin: 0 0 0.25rem 0; font-size: 1.25rem;" id="settings-name">John Doe</h3>
            <p style="margin: 0; color: var(--pm7-muted-foreground);" id="settings-email">john@example.com</p>
            <button type="button" class="pm7-button pm7-button--ghost pm7-button--sm" style="margin-top: 0.5rem;" onclick="changePhoto()">Change Photo</button>
          </div>
        </div>

        <div class="pm7-form-group" style="margin-bottom: 1.5rem;">
          <label for="settings-username" class="pm7-label">Display Name</label>
          <input type="text" id="settings-username" name="username" class="pm7-input" value="John Doe" required>
        </div>

        <div class="pm7-form-group" style="margin-bottom: 1.5rem;">
          <label for="settings-user-email" class="pm7-label">Email Address</label>
          <input type="email" id="settings-user-email" name="email" class="pm7-input" value="john@example.com" required>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <label class="pm7-label" style="display: block; margin-bottom: 0.5rem;">Preferences</label>
          <div style="space-y: 0.5rem;">
            <label class="pm7-checkbox" style="margin-bottom: 0.75rem;">
              <input type="checkbox" id="email-notifications" name="emailNotifications" checked>
              <span class="pm7-checkbox-indicator"></span>
              <span class="pm7-checkbox-label">Email notifications</span>
            </label>
            <label class="pm7-checkbox" style="margin-bottom: 0.75rem;">
              <input type="checkbox" id="auto-save" name="autoSave" checked>
              <span class="pm7-checkbox-indicator"></span>
              <span class="pm7-checkbox-label">Auto-save documents</span>
            </label>
            <label class="pm7-checkbox">
              <input type="checkbox" id="show-tips" name="showTips">
              <span class="pm7-checkbox-indicator"></span>
              <span class="pm7-checkbox-label">Show helpful tips</span>
            </label>
          </div>
        </div>

        <div style="margin-bottom: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--pm7-border);">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--pm7-destructive);">Danger Zone</label>
          <button type="button" class="pm7-button pm7-button--destructive pm7-button--outline" onclick="deleteAccount()">Delete Account</button>
        </div>
      </form>
    </div>
    <div data-pm7-footer style="display: flex; gap: 0.5rem; justify-content: flex-end;">
      <button type="button" class="pm7-button pm7-button--ghost" onclick="window.PM7?.closeDialog?.('account-settings-dialog')">Cancel</button>
      <button type="submit" form="account-settings-form" class="pm7-button pm7-button--primary">Save Changes</button>
    </div>
  </div>

  <!-- Sign Out Confirmation Dialog -->
  <div data-pm7-dialog="signout-dialog" data-pm7-dialog-size="sm" data-pm7-dialog-icon="warning">
    <h2 data-pm7-header>Sign Out</h2>
    <div data-pm7-body>
      <p style="margin-bottom: 0;">Are you sure you want to sign out? Any unsaved changes will be lost.</p>
    </div>
    <div data-pm7-footer style="display: flex; gap: 0.5rem; justify-content: flex-end;">
      <button type="button" class="pm7-button pm7-button--ghost" onclick="window.PM7?.closeDialog?.('signout-dialog')">Cancel</button>
      <button type="button" class="pm7-button pm7-button--primary" onclick="confirmSignOut()">Sign Out</button>
    </div>
  </div>

  <!-- Connected Columns Card -->
  <div class="pm7-card connected-columns-card">
    <div class="pm7-card-header">
      <h3>Connected columns</h3>
    </div>
    <div class="pm7-card-content">
      <p style="font-size: 0.875rem; color: var(--pm7-muted-foreground); margin-bottom: 1rem;">
        Select which columns to include in your export.
      </p>
      
      <div class="column-list">
        <div class="column-item">
          <input type="checkbox" id="col-id" checked>
          <label for="col-id">ID</label>
        </div>
        <div class="column-item">
          <input type="checkbox" id="col-name" checked>
          <label for="col-name">Name</label>
        </div>
        <div class="column-item">
          <input type="checkbox" id="col-email" checked>
          <label for="col-email">Email</label>
        </div>
        <div class="column-item">
          <input type="checkbox" id="col-status" checked>
          <label for="col-status">Status</label>
        </div>
        <div class="column-item">
          <input type="checkbox" id="col-created" checked>
          <label for="col-created">Created Date</label>
        </div>
      </div>
      
      <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--pm7-border);">
        <button class="pm7-button pm7-button--primary pm7-button--sm" style="width: 100%;" onclick="exportCSV()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Exporteer CSV
        </button>
      </div>
    </div>
  </div>

  <script>
    // Export CSV function
    function exportCSV() {
      // Get selected columns
      const selectedColumns = [];
      const columnIds = ['id', 'name', 'email', 'status', 'created'];
      const columnNames = ['ID', 'Name', 'Email', 'Status', 'Created Date'];
      
      columnIds.forEach((id, index) => {
        const checkbox = document.getElementById(`col-${id}`);
        if (checkbox && checkbox.checked) {
          selectedColumns.push({
            id: id,
            name: columnNames[index]
          });
        }
      });
      
      if (selectedColumns.length === 0) {
        alert('Please select at least one column to export.');
        return;
      }
      
      // Sample data for demonstration
      const data = [
        { id: 1, name: 'John Doe', email: 'john@example.com', status: 'Active', created: '2024-01-15' },
        { id: 2, name: 'Jane Smith', email: 'jane@example.com', status: 'Active', created: '2024-01-16' },
        { id: 3, name: 'Bob Johnson', email: 'bob@example.com', status: 'Inactive', created: '2024-01-17' },
        { id: 4, name: 'Alice Williams', email: 'alice@example.com', status: 'Active', created: '2024-01-18' },
        { id: 5, name: 'Charlie Brown', email: 'charlie@example.com', status: 'Pending', created: '2024-01-19' }
      ];
      
      // Build CSV content
      let csvContent = selectedColumns.map(col => col.name).join(',') + '\n';
      
      data.forEach(row => {
        const rowData = selectedColumns.map(col => {
          const value = row[col.id] || '';
          // Escape values containing commas or quotes
          if (value.toString().includes(',') || value.toString().includes('"')) {
            return '"' + value.toString().replace(/"/g, '""') + '"';
          }
          return value;
        });
        csvContent += rowData.join(',') + '\n';
      });
      
      // Create and download the file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', 'export_' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Update status
      if (window.updateStatus) {
        window.updateStatus(`Exported ${data.length} rows to CSV`);
      }
    }
  </script>
</body>
</html>